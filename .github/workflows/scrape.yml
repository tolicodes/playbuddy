name: Call API Scrape

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: Base URL to hit
        required: true
        default: https://api.playbuddy.me
      endpoint_path:
        description: Endpoint to hit (e.g., /events/scrape)
        required: true
        default: /events/scrape
      auth_token:
        description: Bearer token to call the API (optional)
        required: false

  schedule:
    - cron: "0 */12 * * *" # every 12 hours (UTC)

jobs:
  call-api:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: call-api-scrape
      cancel-in-progress: true

    env:
      BASE_URL: ${{ github.event.inputs.base_url || 'https://api.playbuddy.me' }}
      ENDPOINT_PATH: ${{ github.event.inputs.endpoint_path || '/events/scrape' }}
      AUTH_TOKEN: ${{ github.event.inputs.auth_token || secrets.PLAYBUDDY_API_SERVICE_KEY || '' }}

    steps:
      - name: Call scrape endpoint
        run: |
          set -euo pipefail
          URL="${BASE_URL}${ENDPOINT_PATH}"
          NOW="$(date -u +"%Y-%m-%d %H:%M:%SZ")"
          echo "Calling: $URL at $NOW"
          HEADERS=()
          if [ -n "$AUTH_TOKEN" ]; then
            HEADERS+=( -H "Authorization: Bearer ${AUTH_TOKEN}" )
          fi
          curl -fsS --retry 3 --retry-connrefused "${HEADERS[@]}" "$URL"
          echo "Endpoint responded OK at $NOW"
